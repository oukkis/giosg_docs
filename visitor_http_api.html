<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>giosg API Reference - Visitor HTTP API</title>

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

  </head>

  <body class="visitor_http_api">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
      <ul class="toc-footer">
        <li><a href='./index.html'>Home</a></li>
        <li><a href='./http_api.html'>Giosg HTTP API</a></li>
        <li><a href='./visitor_http_api.html'>Visitor HTTP API</a></li>
        <li><a href='./javascript_api.html'>JavaScript SDK API</a></li>
        <li><a href='./giosg_apps.html'>Giosg APPS</a></li>
        <li><a href='./basket.html'>Giosg BASKET</a></li>
      </ul>
      <ul class="toc-footer">
        <li><a href='http://www.giosg.com' target="_blank">Sign Up on giosg.com</a></li>
        <li><a href="https://docs.giosg.com/doku.php?id=public:technical-documentation:backend-api" target="_blank">Old API documentation</a></li>
        <li><a href='https://github.com/tripit/slate' target="_blank">Documentation Powered by Slate</a></li>
      </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id="using-the-visitor-api">Using the visitor API</h1>

<aside class="warning">
This documentation is a <strong>draft</strong>! Anything stated in this document may be changed significantly!
</aside>

<h2 id="authentication">Authentication</h2>

<p>You need to provide a valid JWT token on your Authorization HTTP header for all your API requests.</p>

<p><code class="prettyprint">Authorization: JWT 1bdf7b99ea0a495f960e70f378b8b975ab15f1b2cf954387a3b9825c81939d89</code></p>

<aside class="notice">
The string in the end of the header should be replaced with your JWT token.
</aside>

          <h2 id="accept-header">Accept Header</h2>

<p>You also need to define that you accept JSON-formatted responses by providing the Accept HTTP header:</p>

<p><code class="prettyprint">Accept: application/json</code></p>

<p>Alternatively, if you are unable to customize headers, you may add <code class="prettyprint">format=json</code> GET parameter.</p>

<h2 id="resource-identifiers">Resource identifiers</h2>

<p>Unless stated otherwise, all the resources in the system are identified with a <a title="Universally Unique Identifier" href="https://en.wikipedia.org/wiki/Universally_unique_identifier">Universally Unique Identifier (UUID)</a>. It is always represented as a string ID, in lower case and including dashes.</p>

<p>For example: <code class="prettyprint">9ae65e7d-56c5-11e5-af8d-6c4008c08dfe</code></p>

<h2 id="paginated-collections">Paginated collections</h2>

<blockquote>
<p>An example of a JSON response with a paginated collection</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://service.giosg.com/api/v5/examples?page=2"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example Resource 1"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example Resource 2"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example Resource 3"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example Resource 4"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example Resource 5"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Some of the API endpoints return paginated collections. That means that for large collections of resources, not all resources are returned in a single response, but the response contains an URL that can be used to fetch the next chunk (page) of results.</p>

<p>Paginated collections are objects with the following attributes.</p>

<table><thead>
<tr>
<th style="text-align: left">Attribute</th>
<th style="text-align: left">Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code class="prettyprint">next</code></td>
<td style="text-align: left">string</td>
<td>Full URL for requesting the next page. This is <code class="prettyprint">null</code> if the current page is the last page.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">previous</code></td>
<td style="text-align: left">string</td>
<td>Full URL for requesting the previous page. This is <code class="prettyprint">null</code> if the current page is the first page</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">results</code></td>
<td style="text-align: left">array of objects</td>
<td>The list containing the result resources for the current page. Each item is an object whose attributes depend on the returned resource type.</td>
</tr>
</tbody></table>

<aside class="warning">
Unless stated otherwise, the server only guarantees the order of the resources, but not the number of items returned per page. If you need a specific number of results, then you need to splice the returned list on the client.
</aside>

<aside class="info">
If you need to load all resources using an endpoint returning paginated collections, then you need to check if the <code>next</code> attribute is not <code>null</code>, potentially load the next page and then repeat this until you have loaded and built the full collection of resources.
</aside>

<h2 id="ordering-collections">Ordering collections</h2>

<p>A <a title="Paginated collections" href="#paginated-collections">paginated collection</a> can usually be ordered by using an <code class="prettyprint">ordering</code> attribute.</p>

<p>The allowed sorting criteria depends on the endpoint, but the basic usage is always the same. You have an allowed set of sorting attributes, e.g. <code class="prettyprint">first_name</code>, <code class="prettyprint">last_name</code> and <code class="prettyprint">created_at</code>. You may then choose the primary sorting key and any secondary sorting keys with a comma-separated string, e.g. <code class="prettyprint">last_name,first_name</code>.</p>

<p>Any sorting order is ascending by default, but may be reverted to descending order by prefixing with a minus (<code class="prettyprint">-</code>) character, e.g. <code class="prettyprint">-created_at</code> or <code class="prettyprint">last_name,-created_at</code>.</p>

<h2 id="date-time-format">Date/time format</h2>

<p>Unless stated otherwise, all the date/times returned by API endpoints are ISO-8601 strings with format <code class="prettyprint">YYYY-MM-DDTHH:MM:SS.MSSZ</code>, for example: <code class="prettyprint">2015-08-31T16:32:17.879Z</code>. Also, any date/time URL parameters or attributes send as a request payload accept this same format.</p>

<p>Unless stated otherwise, the times are expressed in UTC timezone!</p>

          <h1 id="rooms-api">Rooms API</h1>

<h2 id="rooms">Rooms</h2>

<p>The room resource that the visitor can access has the following attributes.</p>

<table><thead>
<tr>
<th style="text-align: left">Attribute</th>
<th style="text-align: left">Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code class="prettyprint">id</code></td>
<td style="text-align: left"><a title="Resource identifiers" href="#resource-identifiers">ID</a></td>
<td>The unique identifier of this room</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">display_name</code></td>
<td style="text-align: left">string</td>
<td>Name of the room</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">language_code</code></td>
<td style="text-align: left">string</td>
<td>Language of this room in ISO 639-1 code, or <code class="prettyprint">null</code> if undefined.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">is_online</code></td>
<td style="text-align: left">boolean</td>
<td>Are there any users online in this room that the the visitor can chat with</td>
</tr>
</tbody></table>

<h3 id="retrieve-room-details">Retrieve room details</h3>

<p>Get a single room object by its ID. This may be a shared room.</p>

<p><code class="prettyprint">GET https://service.giosg.com/api/v5/client/rooms/&lt;room_id&gt;</code></p>

<h3 id="channels">Channels</h3>

<p>Any changes to rooms are notified to the following <a title="Socket API and channels" href="#socket-api">channels</a>:</p>

<table><thead>
<tr>
<th>Channel</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">/api/v5/client/rooms/&lt;room_id&gt;</code></td>
<td>Visitors will receive updates any rooms they subscribe to through this channel</td>
</tr>
</tbody></table>

<h2 id="online-users-in-a-room">Online users in a Room</h2>

<p>Visitors can fetch a collection of online users in a room</p>

<table><thead>
<tr>
<th style="text-align: left">Attribute</th>
<th style="text-align: left">Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code class="prettyprint">id</code></td>
<td style="text-align: left"><a title="Resource identifiers" href="#resource-identifiers">ID</a></td>
<td>Unique identifier</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">public_name</code></td>
<td style="text-align: left">string</td>
<td>The name of the user as it would be displayed for the visitor. This is user&rsquo;s alias if they have one, otherwise it is their real name.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">avatar</code></td>
<td style="text-align: left">object</td>
<td>The avatar of the user as an object. It contains attributes <code class="prettyprint">id</code>and <code class="prettyprint">url</code>. This is <code class="prettyprint">null</code> if the user has no avatar.</td>
</tr>
</tbody></table>

<h3 id="retrieve-a-list-of-online-users-in-a-room">Retrieve a list of online users in a room</h3>

<p><code class="prettyprint">GET https://service.giosg.com/api/v5/client/rooms/&lt;room_id&gt;/online_users</code></p>

<h3 id="channels">Channels</h3>

<p>Any changes to rooms are notified to the following <a title="Socket API and channels" href="#socket-api">channels</a>:</p>

<table><thead>
<tr>
<th>Channel</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">/api/v5/client/rooms/&lt;room_id&gt;/online_users</code></td>
<td>Changes to online user collection in a single room will be broadcasted to this channel</td>
</tr>
</tbody></table>

          <h1 id="chat-api">Chat API</h1>

<h2 id="chats">Chats</h2>

<p>A chat represents a single conversation. In practice, there is usually zero or one visitor member and an arbitrary number of user (&ldquo;operator&rdquo;) members.</p>

<p>A chat has the following attributes:</p>

<table><thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Editable</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">id</code></td>
<td><a title="Resource identifiers" href="#resource-identifiers">ID</a></td>
<td>read-only</td>
<td>Unique identifier for the chat</td>
</tr>
<tr>
<td><code class="prettyprint">token</code></td>
<td>string</td>
<td>read-only</td>
<td>A legacy Giosg-signed encoded unique string for the chat</td>
</tr>
<tr>
<td><code class="prettyprint">created_at</code></td>
<td><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td>read-only</td>
<td>When the chat conversation started</td>
</tr>
<tr>
<td><code class="prettyprint">ended_at</code></td>
<td><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td>read-only</td>
<td>When the chat conversation ended (or <code class="prettyprint">null</code> if not yet ended)</td>
</tr>
<tr>
<td><code class="prettyprint">updated_at</code></td>
<td><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td>read-only</td>
<td>When the chat conversation was last time updated</td>
</tr>
<tr>
<td><code class="prettyprint">is_autosuggested</code></td>
<td>boolean</td>
<td>read-only</td>
<td>Whether or not the chat started with an autosuggestion</td>
</tr>
<tr>
<td><code class="prettyprint">room_id</code></td>
<td><a title="Resource identifiers" href="#resource-identifiers">ID</a></td>
<td>read-only</td>
<td>ID of the <a title="Rooms and domains" href="#rooms-and-domains">room</a> in which the chat occurred</td>
</tr>
<tr>
<td><code class="prettyprint">message_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many <a title="Chat messages" href="#chat-messages">messages</a> there are in total in this chat at the moment. <strong>NOTE</strong> that this only includes messages with type <code class="prettyprint">msg</code>, so this does <strong>not</strong> include autosuggestions, or join/leave messages.</td>
</tr>
<tr>
<td><code class="prettyprint">user_message_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many <a title="Chat messages" href="#chat-messages">messages</a> there were by operator in this chat</td>
</tr>
<tr>
<td><code class="prettyprint">visitor_message_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many <a title="Chat messages" href="#chat-messages">messages</a> there were by visitor in this chat</td>
</tr>
<tr>
<td><code class="prettyprint">present_member_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many people (visitor and users) there are currently present at this chat.</td>
</tr>
<tr>
<td><code class="prettyprint">present_user_member_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many users there are currently present at this chat.</td>
</tr>
<tr>
<td><code class="prettyprint">present_visitor_member_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many visitor there are currently present at this chat (0 or 1)</td>
</tr>
<tr>
<td><code class="prettyprint">member_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many people (visitor and users) have attended or sent messages to this chat.</td>
</tr>
<tr>
<td><code class="prettyprint">user_member_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many users have sent at least one message to the chat.</td>
</tr>
<tr>
<td><code class="prettyprint">visitor_member_count</code></td>
<td>integer</td>
<td>read-only</td>
<td>How many visitors have attended this chat.</td>
</tr>
</tbody></table>

<p>Any changes to chats are notified to the following <a title="Socket API and channels" href="#socket-api">channels</a>:</p>

<table><thead>
<tr>
<th>Channel</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">/api/v5/client/visitors/&lt;visitor_id&gt;/chats</code></td>
<td>For each visitor of the chat</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/users/&lt;user_id&gt;/chats</code></td>
<td>For each user <a title="Chat memberships" href="#chat-memberships">member of the chat</a></td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/rooms/&lt;room_id&gt;/chats</code></td>
<td>For the chat parent room chat collection and each organization having access to that room</td>
</tr>
</tbody></table>

<h3 id="list-visitor-39-s-chats">List visitor&rsquo;s chats</h3>

<p>You can get a list of all chats of the visitor.</p>
<pre class="highlight plaintext"><code>GET https://service.giosg.com/api/v5/client/visitors/3803737880ec4dedb7eee63a860bfff2/chats
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://service.giosg.com/api/v5/client/visitors/3803737880ec4dedb7eee63a860bfff2/chats?cursor=48d7ca8d5a394ff99a32720ccf7893bd"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"58f5055c-56e0-11e5-9354-6c4008c08dfe"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uibdbtmk5etolmjaduaafnqpl2ujzkyr4slkq3cabdai37qm"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T11:31:36.042"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"ended_at"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T12:38:36.431"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"is_autosuggested"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nt">"room_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9926bdfa-56e0-11e5-b98c-6c4008c08dfe"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"message_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nt">"user_message_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nt">"visitor_message_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nt">"present_member_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nt">"present_user_member_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nt">"present_visitor_member_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nt">"user_member_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nt">"visitor_member_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><code class="prettyprint">GET /api/v5/client/visitors/&lt;visitor_id&gt;/chats</code></p>

<p>This API endpoint returns a <a title="Paginated collections" href="#paginated-collections">paginated collection</a>. They are sorted by the creation time of the chats, in ascending order.</p>

<h3 id="create-a-new-chat">Create a new chat</h3>

<p>Start a new chat with a visitor in the given room.</p>

<p><code class="prettyprint">POST /api/v5/client/visitors/&lt;visitor_id&gt;/rooms/&lt;room_id&gt;/chats</code></p>

<p>The visitor will automatically be added as member of the chat by creating a <a title="Chat memberships" href="#chat-memberships">chat membership</a> resource.</p>

<table><thead>
<tr>
<th style="text-align: left">Parameter</th>
<th style="text-align: left">Format</th>
<th style="text-align: left">Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code class="prettyprint">auto_resume</code></td>
<td style="text-align: left"><code class="prettyprint">true</code>/<code class="prettyprint">false</code></td>
<td style="text-align: left"><code class="prettyprint">false</code></td>
<td>If provided, then attempt to get an existing recent chat in this room where the visitor is already a member, instead of creating a new chat.</td>
</tr>
</tbody></table>

<p>Returns 201 status code when a new chat was created successfully.
Returns 200 if resumed an existing chat when <code class="prettyprint">auto_resume</code> parameter was provided.</p>

<h2 id="chat-memberships">Chat memberships</h2>

<p>The visitor and each user who has participated to a chat is added as a chat membership to the chat.</p>

<table><thead>
<tr>
<th style="text-align: left">Attribute</th>
<th style="text-align: left">Format</th>
<th style="text-align: left">Editable</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code class="prettyprint">member_id</code></td>
<td style="text-align: left"><a title="Resource identifiers" href="#resource-identifiers">ID</a>/string</td>
<td style="text-align: left">read-only</td>
<td>ID of the user or visitor being present at the chat.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">member_type</code></td>
<td style="text-align: left">string</td>
<td style="text-align: left">read-only</td>
<td>Either <code class="prettyprint">visitor</code> or <code class="prettyprint">user</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">member_public_name</code></td>
<td style="text-align: left">string</td>
<td style="text-align: left">read-only</td>
<td>The name of the user/visitor as it would be displayed for the visitor. This is user&rsquo;s alias if they have one, otherwise it is their real name. For visitors, this is any custom username (e.g. set by API data) or <code class="prettyprint">null</code></td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">member_avatar</code></td>
<td style="text-align: left">object</td>
<td style="text-align: left">read-only</td>
<td>If the user/visitor has an avatar image, then this is is an object with <code class="prettyprint">id</code> and <code class="prettyprint">url</code> attributes. Otherwise this is <code class="prettyprint">null</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">chat_id</code></td>
<td style="text-align: left"><a title="Resource identifiers" href="#resource-identifiers">ID</a></td>
<td style="text-align: left">read-only</td>
<td>ID of the chat.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">created_at</code></td>
<td style="text-align: left"><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td style="text-align: left">read-only</td>
<td>When the user/visitor was added as a chat member.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">updated_at</code></td>
<td style="text-align: left"><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td style="text-align: left">read-only</td>
<td>When the this membership was updated.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">message_count</code></td>
<td style="text-align: left">integer</td>
<td style="text-align: left">read-only</td>
<td>How many messages the user/visitor has sent to the chat. This may be 0, e.g. when operator has joined the chat but has not sent any message yet.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">is_participating</code></td>
<td style="text-align: left">boolean</td>
<td style="text-align: left"><strong>required</strong></td>
<td>Whether or not the user/visitor has the chat &ldquo;open&rdquo;. In practise this reflects the state of the chat window. When the user/visitor closes the chat window, it is supposed that he is no more participating the chat (but the membership still remains)</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">is_present</code></td>
<td style="text-align: left">boolean</td>
<td style="text-align: left">read-only</td>
<td>Whether or not the user/visitor is currently present. Equals the <code class="prettyprint">is_present</code> attribute of the member.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">composing_status</code></td>
<td style="text-align: left">string</td>
<td style="text-align: left"><strong>required</strong></td>
<td>One of the following: <code class="prettyprint">idle</code>, <code class="prettyprint">composing</code>, <code class="prettyprint">has_composed</code>. The <code class="prettyprint">composing</code> status will be automatically downgraded to <code class="prettyprint">has_composed</code> if the composing status has not been refreshed for a while.</td>
</tr>
</tbody></table>

<p>Changes to chat memberships are notified to the following <a title="Socket API and channels" href="#socket-api">channels</a>:</p>

<table><thead>
<tr>
<th>Channels</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">/api/v5/client/visitors/&lt;visitor_id&gt;/chats/&lt;chat_id&gt;/memberships</code></td>
<td>For each visitor of the chat</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/client/visitors/&lt;visitor_id&gt;/chats_memberships</code></td>
<td>For the chat member, if a visitor</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/users/&lt;user_id&gt;/chats/&lt;chat_id&gt;/memberships</code></td>
<td>For each user membership of the chat</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/rooms/&lt;room_id&gt;/chats/&lt;chat_id&gt;/memberships</code></td>
<td>For the related room and each organization having access to that room</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/users/&lt;user_id&gt;/chat_memberships</code></td>
<td>For the chat member, if a user</td>
</tr>
</tbody></table>

<p>In addition, chat members affect the following attributes of a <a title="Chats" href="#chats">chat</a>, notifying its channels:</p>

<ul>
<li><code class="prettyprint">member_count</code></li>
<li><code class="prettyprint">user_member_count</code></li>
<li><code class="prettyprint">visitor_member_count</code></li>
<li><code class="prettyprint">present_member_count</code></li>
<li><code class="prettyprint">present_user_member_count</code></li>
<li><code class="prettyprint">present_visitor_member_count</code></li>
</ul>

<h3 id="list-chat-memberships">List chat memberships</h3>
<pre class="highlight plaintext"><code>GET https://service.giosg.com/api/v5/client/visitors/3b90ef7c93484af4965a79ace7bc9a62/chats/58f5055c-56e0-11e5-9354-6c4008c08dfe/memberships
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://service.giosg.com/api/v5/client/visitors/3b90ef7c93484af4965a79ace7bc9a62/chats/58f5055c-56e0-11e5-9354-6c4008c08dfe/memberships?cursor=45d9e7358e1249c491b4fa0212310f55"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"member_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"378ad5a0-bb89-481b-978b-4268b368cfef"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_public_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Customer Service"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_avatar"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7f9cb877-0fd9-4c27-90b0-bd4c2842da3d"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://www.example.com/avatar/5ef1a0ef-8b61-4473-8706-9669e30b47e6.jpg"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nt">"chat_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"58f5055c-56e0-11e5-9354-6c4008c08dfe"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T11:31:36.042"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"is_participating"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nt">"is_present"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nt">"composing_status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"idle"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"message_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"member_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3b90ef7c93484af4965a79ace7bc9a62"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"visitor"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_public_name"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"member_avatar"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"chat_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"58f5055c-56e0-11e5-9354-6c4008c08dfe"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T12:14:34.154"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"is_participating"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nt">"is_present"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nt">"composing_status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"composing"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"message_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>You may get a <a title="Paginated collections" href="#paginated-collections">paginated collection</a> of all memberships of a chat.</p>

<p><code class="prettyprint">GET /api/v5/client/visitors/&lt;visitor_id&gt;/chats/&lt;chat_id&gt;/memberships</code></p>

<p>Returns 404 if the chat is not one of the visitor&rsquo;s chats.</p>

<h3 id="list-chat-memberships-of-a-visitor">List chat memberships of a visitor</h3>

<p>As an alternative to list a visitor&rsquo;s <em>chats</em>, you can also list a visitor&rsquo;s <em>chat memberships</em> as a <a title="Paginated collections" href="#paginated-collections">paginated collection</a>. This includes each chat membership object that represents the visitor in each of his chats.</p>

<p><code class="prettyprint">GET /api/v5/client/visitors/&lt;visitor_id&gt;/chat_memberships</code></p>

<h3 id="change-visitor-chat-status">Change visitor chat status</h3>

<blockquote>
<p>Example request for making the visitor typing at the chat</p>
</blockquote>
<pre class="highlight plaintext"><code>PUT /api/v5/client/visitors/5cd16aaf35d6488094a5f160afa29767/chat_memberships/e9f4c403-0d0f-4bb8-9883-8f2eb5c9079b
</code></pre>

<blockquote>
<p>Example request payload</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"is_participating"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nt">"composing_status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"composing"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>The participation status should be refreshed when the visitor opens or closes a chat. In addition, you should frequently notify the backend about the composing status of the visitor. For example, you should make a request when the visitor starts typing a message for the chat (and more requests frequently if the visitor keeps typing, stops typing or clears the composition area).</p>

<p>You can change the chat status of the visitor:</p>

<p><code class="prettyprint">PUT /api/v5/client/visitors/&lt;visitor_id&gt;/chat_memberships/&lt;chat_id&gt;</code></p>

<h2 id="chat-messages">Chat messages</h2>

<p>Chat consists of a number of messages. Some of them are actual typed messages from either operator or visitor, and some of them are automatically added events about the chat, especially when an operator has joined or leaved the chat.</p>

<table><thead>
<tr>
<th style="text-align: left">Attribute</th>
<th style="text-align: left">Type</th>
<th>Editable</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code class="prettyprint">id</code></td>
<td style="text-align: left"><a title="Resource identifiers" href="#resource-identifiers">ID</a></td>
<td>read-only</td>
<td>Unique identifier for the message</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">type</code></td>
<td style="text-align: left">string</td>
<td>read-only</td>
<td>Whether the message is an actual message (<code class="prettyprint">msg</code>), autosuggest (<code class="prettyprint">autosuggest</code>), a join event (<code class="prettyprint">join</code>) or a leave event (<code class="prettyprint">leave</code>). When POSTing a message, this will automatically be set to <code class="prettyprint">msg</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">created_at</code></td>
<td style="text-align: left"><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td>read-only</td>
<td>When the message was sent</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">sender_type</code></td>
<td style="text-align: left">string</td>
<td>read-only</td>
<td>Whether the sender is operator (<code class="prettyprint">user</code>) or visitor (<code class="prettyprint">visitor</code>). When POSTing a new message with these endpoints, this will automatically be set to <code class="prettyprint">user</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">sender_id</code></td>
<td style="text-align: left"><a title="Resource identifiers" href="#resource-identifiers">ID</a>/string</td>
<td>read-only</td>
<td>Identifier for the sender. If the sender is a user, then this is the user&rsquo;s ID. Otherwise this is an unique string for the visitor.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">sender_public_name</code></td>
<td style="text-align: left">string</td>
<td>read-only</td>
<td>A display name for the sender as the visitor would see him.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">sender_avatar</code></td>
<td style="text-align: left">object</td>
<td>read-only</td>
<td>If the sender has an avatar image, then this is an object with <code class="prettyprint">id</code> and <code class="prettyprint">url</code> attributes. Otherwise this is <code class="prettyprint">null</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code class="prettyprint">message</code></td>
<td style="text-align: left">string</td>
<td><strong>required</strong></td>
<td>Content text of the message. The maximum length is 2000 characters.</td>
</tr>
</tbody></table>

<p>Any changes to chat messages are notified to the following <a title="Socket API and channels" href="#socket-api">channels</a>:</p>

<table><thead>
<tr>
<th>Channel</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">/api/v5/client/visitors/&lt;visitor_id&gt;/chats/&lt;chat_id&gt;/messages</code></td>
<td>For each visitor of the chat</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/users/&lt;user_id&gt;/chats/&lt;chat_id&gt;/messages</code></td>
<td>For each member and currently present user of the chat</td>
</tr>
<tr>
<td><code class="prettyprint">/api/v5/orgs/&lt;organization_id&gt;/rooms/&lt;room_id&gt;/chats/&lt;chat_id&gt;/messages</code></td>
<td>For the chat parent room chat collection and each organization having access to that room</td>
</tr>
</tbody></table>

<p>In addition, sending chat messages affect the following attributes of a <a title="Chats" href="#chats">chat</a>, which notifies the channels of the chat.</p>

<ul>
<li><code class="prettyprint">message_count</code></li>
<li><code class="prettyprint">user_message_count</code></li>
<li><code class="prettyprint">visitor_message_count</code></li>
<li><code class="prettyprint">is_waiting</code></li>
</ul>

<p>In addition, sending chat messages affect the following attributes of a <a title="Chat memberships" href="#chat-memberships">chat membership</a>, notifying its related channels.</p>

<ul>
<li><code class="prettyprint">message_count</code></li>
</ul>

<h3 id="list-chat-messages">List chat messages</h3>
<pre class="highlight plaintext"><code>GET https://service.giosg.com/api/v5/client/visitors/f7a5a3b83d2e40dfb0dedd6c0e284214/chats/450fc49e-277e-4dd6-af0f-6e9dcb885b09/messages
</code></pre>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://service.giosg.com/api/v5/client/visitors/f7a5a3b83d2e40dfb0dedd6c0e284214/chats/450fc49e-277e-4dd6-af0f-6e9dcb885b09/messages?cursor=171cfd0d7ce542be86221f01d2823cb1"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"8a94b3f1-d8a9-4530-b1f1-b757a8a57078"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"autosuggest"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T11:30:03.045"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7c94ae79-a4b4-4eea-ac23-24c16f910080"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_public_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Customer Service"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"How may I help you?"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"58f5055c-56e0-11e5-9354-6c4008c08dfe"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"msg"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T11:31:36.042"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"visitor"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f7a5a3b83d2e40dfb0dedd6c0e284214"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_public_name"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Yes, actually you could."</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a3a3b8ed-7336-431a-8350-8f5be471a09e"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"join"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T11:31:38.123"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7c94ae79-a4b4-4eea-ac23-24c16f910080"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_public_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Customer Service"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"487a4dce-503a-43d0-bd62-1e1a7582c93b"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"msg"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-02-13T11:32:01.654"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7c94ae79-a4b4-4eea-ac23-24c16f910080"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sender_public_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Customer Service"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OK, what do you want to know?"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Get the collection of all chat messages in the given chat.</p>

<p><code class="prettyprint">GET /api/v5/client/visitors/&lt;visitor_id&gt;/chats/&lt;chat_id&gt;/messages</code></p>

<h3 id="send-a-chat-message">Send a chat message</h3>
<pre class="highlight plaintext"><code>POST https://service.giosg.com/api/v5/client/visitors/be82243cf82540c49a629543022a3de2/chats/4a591004-4c18-4260-bbb4-fc9f9f9a048d/messages
</code></pre>

<blockquote>
<p>Example request payload</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Thank you for your help!"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Send a new chat message with type <code class="prettyprint">msg</code> to a chat.</p>

<p><code class="prettyprint">POST /api/v5/client/visitors/&lt;visitor_id&gt;/chats/&lt;chat_id&gt;/messages</code></p>

<p>Returns 404 if the chat is not one of the visitor&rsquo;s chats.</p>

<p>The <code class="prettyprint">sender_type</code> is automatically set to <code class="prettyprint">visitor</code> and <code class="prettyprint">sender_id</code> is set to <code class="prettyprint">&lt;visitod_id&gt;</code>.</p>

<p>If this is the first message with type <code class="prettyprint">msg</code> in the chat, then its <code class="prettyprint">is_waiting</code> attribute is automatically set to <code class="prettyprint">true</code>. (This only affects the authenticated users)</p>

          <h1 id="socket-api">Socket API</h1>

<p>You can listen real-time notifications about any interesting changes in the system by subscribing a <strong>channel on the message router</strong>.</p>

<h2 id="retrieving-message-router-information">Retrieving message router information</h2>
<pre class="highlight plaintext"><code>GET https://service.giosg.com/api/v5/messagerouter
</code></pre>

<blockquote>
<p>An example response</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://messagerouter.giosg.com/003/2/router"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"permission_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.we2snuuhq-cnPk-GMJVoBhyZ7ZKPa95Qxe_3VkEaf_E"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"expires_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-12-22T11:25:30.595Z"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"expires_in"</span><span class="p">:</span><span class="w"> </span><span class="mi">1800</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>In order to make a connection to the message router you need to make a HTTP request to the following endpoint:</p>

<p><code class="prettyprint">GET /api/v5/messagerouter</code></p>

<p>This returns an object with the following attributes:</p>

<table><thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">url</code></td>
<td>string</td>
<td>The URL where the client should open the socket connection.</td>
</tr>
<tr>
<td><code class="prettyprint">permission_token</code></td>
<td>string</td>
<td>A JWT permission token that is required when subscribing to real-time channels.</td>
</tr>
<tr>
<td><code class="prettyprint">expires_at</code></td>
<td><a title="Date/time format" href="#date-time-format">date/time</a></td>
<td>When the permission token expires. You should retrieve a new token before this.</td>
</tr>
<tr>
<td><code class="prettyprint">expires_in</code></td>
<td>integer</td>
<td>After how many seconds the permission token will expire. You should retrieve a new token before this.</td>
</tr>
</tbody></table>

<h2 id="subscribing-socket-channels">Subscribing socket channels</h2>

<p>Both users and visitors use a socket connection to receive real-time notifications about the changes. Notifications are delivered through <strong>channels</strong>.</p>

<p>Subscribing the channels is done in the following way:</p>

<p><strong>Step 1</strong>: The client opens a connection with <strong>message router</strong></p>
<pre class="highlight json"><code><span class="p">[</span><span class="s2">"sub"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"&lt;channel_id&gt;"</span><span class="p">,</span><span class="w"> </span><span class="s2">"&lt;permission_token&gt;"</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="nt">"query"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234567</span><span class="p">}]</span><span class="w">
</span></code></pre>

<p><strong>Step 2</strong>: The client sends a <code class="prettyprint">sub</code> message with an arbitrary but unique query ID for a channel they want to subscribe.</p>

<p>The <code class="prettyprint">&lt;channel_id&gt;</code> must be the ID of the channel being subscribed. The channel ID matches the URL path of the API endpoint where the resource or resource collection would be retrieved. For example: <code class="prettyprint">/api/v5/client/visitors/e725acaa886f414986257bfe98d4db1c/chats</code> or <code class="prettyprint">/api/v5/orgs/dc5e32c1-54d2-4010-8c04-8b66e565698e/rooms/3f7f6058-af90-4499-b769-9bb348af5736</code>.</p>

<p>The <code class="prettyprint">&lt;permission_token&gt;</code> must be the JWT permission token string. If the token is valid and it grants the permission to the requested channel, then the subscription will be accepted.</p>

<aside class="warning">
If the connection is closed and then re-opened, the client needs to re-send the <code>sub</code> messages for every channel they still want to subscribe!
</aside>
<pre class="highlight json"><code><span class="p">[</span><span class="s2">"__qr__"</span><span class="p">,</span><span class="w"> </span><span class="p">[[]],</span><span class="w"> </span><span class="p">{</span><span class="nt">"query"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234567</span><span class="p">}]</span><span class="w">
</span></code></pre>

<p><strong>Step 3</strong>: The client receives a <code class="prettyprint">__qr__</code> message (query response) whenever the subscription is confirmed. The response message contains the same <code class="prettyprint">query</code> identifier. The client is now receiving notifications to this channel.</p>

<p>If the <code class="prettyprint">&lt;permission_token&gt;</code> was not valid or it did not grant access to the channel, then the object also contains <code class="prettyprint">fail</code> attribute with value <code class="prettyprint">true</code>.</p>
<pre class="highlight json"><code><span class="p">[</span><span class="s2">"changed"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"&lt;channel_id&gt;"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;action_type&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"resourceId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f39b84ae-c54c-4de3-a096-9ecde4f07f34"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f39b84ae-c54c-4de3-a096-9ecde4f07f34"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Resource Name"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-08-31T16:32:17.879Z"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}]]</span><span class="w">
</span></code></pre>

<p><strong>Step 4</strong>: The client receives a <code class="prettyprint">changed</code> message as a notification about an added, removed or changed resource.</p>

<p>There are three possible values for the <code class="prettyprint">action</code>:</p>

<table><thead>
<tr>
<th>Action</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">added</code></td>
<td>A new resource has been added to the collection the channel represents. The <code class="prettyprint">resource</code> field contains the full resource object.</td>
</tr>
<tr>
<td><code class="prettyprint">changed</code></td>
<td>Attributes of a resource have changed. The <code class="prettyprint">resourceId</code> attribute describes which resource was changed (see below). The <code class="prettyprint">resource</code> field contains <strong>only the changed attributes</strong> of the resource.</td>
</tr>
<tr>
<td><code class="prettyprint">removed</code></td>
<td>A resource has been removed from the collection the channel represents. The <code class="prettyprint">resourceId</code> attribute describes which resource was removed (see below).</td>
</tr>
</tbody></table>

<p>When the channel represents a collection of resources, the <code class="prettyprint">resourceId</code> attribute describes which existing resource was altered. In most cases, the <code class="prettyprint">resourceId</code> matches the value of the resource&rsquo;s <code class="prettyprint">id</code> attribute. However, in some cases the identity attribute may have some other name, so it is client&rsquo;s responsibility to assign the changes to the correct resource.</p>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
